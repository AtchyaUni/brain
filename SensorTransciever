/*
  ESP32 #1: Ultrasonic (HC-SR04) + ESP-NOW Transmitter
  TRIG = GPIO23
  ECHO = GPIO22  (USE VOLTAGE DIVIDER! HC-SR04 echo is 5V)
*/

#include <esp_now.h>
#include <WiFi.h>
#include <string.h>

#define TRIG_PIN 23
#define ECHO_PIN 22

// ✅ Put your RECEIVER ESP32 MAC address here (ESP32 #2)
uint8_t receiverMac[] = {0xE0, 0x8C, 0xFE, 0x5C, 0x1B, 0xA4};  // example

// Data structure (must match receiver exactly)
typedef struct struct_message {
  float distance_cm;
  uint32_t duration_us;
} struct_message;

struct_message myData;
esp_now_peer_info_t peerInfo;

void OnDataSent(const uint8_t *mac_addr, esp_now_send_status_t status) {
  Serial.print("ESP-NOW send status: ");
  Serial.println(status == ESP_NOW_SEND_SUCCESS ? "Delivery Success" : "Delivery Fail");
}

float readDistanceCm(uint32_t &durationOut) {
  // Ensure clean trigger
  digitalWrite(TRIG_PIN, LOW);
  delayMicroseconds(2);

  // 10 us pulse
  digitalWrite(TRIG_PIN, HIGH);
  delayMicroseconds(10);
  digitalWrite(TRIG_PIN, LOW);

  // Read echo pulse (timeout to avoid hanging forever)
  // 25 ms timeout ~ 4.3 m max range
  uint32_t duration = pulseIn(ECHO_PIN, HIGH, 25000);

  durationOut = duration;

  // If timeout/no echo
  if (duration == 0) return -1.0;

  // distance (cm) = duration_us * speed_of_sound / 2
  // speed_of_sound ≈ 0.0343 cm/us, so /2 -> 0.01715
  return 0.01715f * (float)duration;
}

void setup() {
  Serial.begin(115200);

  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);

  WiFi.mode(WIFI_STA);

  if (esp_now_init() != ESP_OK) {
    Serial.println("Error initializing ESP-NOW");
    return;
  }

  esp_now_register_send_cb(OnDataSent);

  // Register peer (receiver)
  memset(&peerInfo, 0, sizeof(peerInfo));
  memcpy(peerInfo.peer_addr, receiverMac, 6);
  peerInfo.channel = 0;
  peerInfo.encrypt = false;

  if (esp_now_add_peer(&peerInfo) != ESP_OK) {
    Serial.println("Failed to add peer");
    return;
  }

  Serial.println("Transmitter ready.");
}

void loop() {
  uint32_t dur;
  float dist = readDistanceCm(dur);

  myData.distance_cm = dist;
  myData.duration_us = dur;

  // Send via ESP-NOW
  esp_err_t result = esp_now_send(receiverMac, (uint8_t *)&myData, sizeof(myData));

  if (result == ESP_OK) {
    Serial.print("Sent distance: ");
    Serial.print(dist);
    Serial.print(" cm, duration: ");
    Serial.println(dur);
  } else {
    Serial.println("Send error");
  }

  delay(500);
}
